<!DOCTYPE html>
<html>

<head>
        <meta charset="UTF-8">
        <title>llama.cpp Batch Chat</title>
        <style>
                body {
                        font-family: Arial;
                        margin: 40px;
                }

                #output {
                        white-space: pre-wrap;
                        background: #f0f0f0;
                        padding: 20px;
                        border-radius: 6px;
                        height: 500px;
                        overflow-y: auto;
                }

                .tps {
                        color: #999;
                        font-size: 0.9em;
                }

                button {
                        padding: 10px 20px;
                        font-size: 1em;
                        background: #10a37f;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        margin-right: 10px;
                }

                #controls {
                        margin-bottom: 20px;
                }
        </style>
</head>

<body>
        <h2>üìÑ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§ÌñâÍ∏∞</h2>
        <div id="controls">
                <button onclick="runAll()">Î™®Îì† Ï§Ñ Ïã§Ìñâ</button>
                <button onclick="stop()">Ï†ïÏßÄ</button>
        </div>
        <div id="output"></div>

        <script>
                let controller = null;

                function runAll() {
                        const output = document.getElementById("output");
                        output.innerHTML = "";

                        controller = new AbortController(); // ÏÉà AbortController ÏÉùÏÑ±
                        const signal = controller.signal;

                        fetch("/run", { method: "POST", signal }).then(res => {
                                const reader = res.body.getReader();
                                const decoder = new TextDecoder("utf-8");

                                let buffer = "";

                                function read() {
                                        reader.read().then(({ done, value }) => {
                                                if (done) return;
                                                const chunk = decoder.decode(value, { stream: true });
                                                buffer += chunk;

                                                const parts = buffer.split(/(<tps>.*?<\/tps>)/g);
                                                buffer = "";

                                                parts.forEach(part => {
                                                        if (part.startsWith("<tps>")) {
                                                                const tps = part.replace("<tps>", "").replace("</tps>", "");
                                                                document.querySelector(".tps")?.remove();
                                                                const tpsSpan = document.createElement("div");
                                                                tpsSpan.className = "tps";
                                                                tpsSpan.innerText = `‚ö° Token/s: ${tps}`;
                                                                output.appendChild(tpsSpan);
                                                        } else {
                                                                output.innerHTML += part;
                                                        }
                                                });

                                                output.scrollTop = output.scrollHeight;
                                                read();
                                        }).catch(err => {
                                                if (err.name === "AbortError") {
                                                        console.log("Fetch aborted.");
                                                        const stopNotice = document.createElement("div");
                                                        stopNotice.innerText = "‚èπÔ∏è Ïã§Ìñâ Ï§ëÎã®Îê®.";
                                                        output.appendChild(stopNotice);
                                                } else {
                                                        console.error("Read error:", err);
                                                }
                                        });
                                }

                                read();
                        }).catch(err => {
                                if (err.name !== "AbortError") {
                                        console.error("Fetch error:", err);
                                }
                        });
                }

                function stop() {
                        if (controller) {
                                controller.abort();
                                controller = null;
                        }
                }
        </script>
</body>

</html>